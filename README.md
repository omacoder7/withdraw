## Withdraw UI

Страница `Withdraw` реализована на базе Next.js App Router и TypeScript и работает с моковым API вывода средств.

### Как запустить

- **Установка зависимостей**:

```bash
npm install
```

- **Dev-сервер**:

```bash
npm run dev
```

Приложение будет доступно по адресу `http://localhost:3000`. Главная страница сразу отображает `Withdraw`-форму.

- **Запуск тестов**:

```bash
npm test
```

Используется `vitest` + `@testing-library/react`.

### Архитектура и ключевые решения

- **Next.js App Router + TypeScript**: вся логика в папке `app`, типизация строгая (`strict: true` в `tsconfig.json`).
- **Состояние**: используется `Zustand` (`app/store/withdrawStore.ts`) для хранения:
  - значений формы (`amount`, `destination`, `confirm`);
  - UI-состояния (`status: idle/loading/success/error`, тип ошибки);
  - последней созданной заявки и `idempotency_key`.
- **API-слой**:
  - `POST /api/v1/withdrawals` — создание заявки, принимает `amount` и `destination`, требует заголовок `Idempotency-Key`;
  - `GET /api/v1/withdrawals/:id` — получение статуса заявки;
  - данные хранятся в памяти процесса (Map) с глобальным стором, чтобы POST/GET видели одни и те же заявки;
  - при повторном `idempotency_key` возвращается `409` с понятным текстом (на UI отображается человекочитаемое сообщение).
- **UI-устойчивость**:
  - четкие состояния: `idle` (форма доступна), `loading` (submit задизейблен, отображается текст о выполнении запроса), `success` (показывается карточка заявки), `error` (баннер с ошибкой);
  - защита от двойного submit: кнопка `Создать заявку` дизейблится на время запроса, а хэндлер дополнительно проверяет `loading`;
  - при сетевой ошибке (`TypeError`) UI показывает отдельное сообщение и кнопку `Повторить запрос`, которая повторно отправляет запрос с тем же `idempotency_key` и без потери данных формы;
  - после успешного создания заявки можно обновить её статус через кнопку `Обновить статус` (вызывает `GET /v1/withdrawals/{id}`).
- **Валидация формы**:
  - `amount > 0`, числовое значение;
  - `destination` — обязательная непустая строка;
  - чекбокс подтверждения должен быть отмечен;
  - submit доступен только при валидной форме и когда нет активного запроса.
- **Восстановление последней заявки после reload (optional)**:
  - последнее состояние формы и последняя заявка хранятся в `sessionStorage` не дольше 5 минут;
  - при загрузке страницы стор восстанавливается из снапшота и позволяет продолжить работу без потери данных.

### Безопасность и работа с токенами

- В данном тестовом проекте **аутентификация моковая**, access token не используется и не хранится.
- В прод-среде для интеграции с реальным backend/Web3:
  - **не хранить access token в `localStorage` или `sessionStorage`**, чтобы уменьшить риск XSS;
  - использовать **HTTP-only secure cookies** для access/refresh токенов;
  - разделять короткоживущий access token и более долгий refresh token;
  - защищать критичные эндпоинты CSRF-токенами или double-submit-cookie;
  - не рендерить пользовательский ввод через `dangerouslySetInnerHTML`; в UI используются только обычные текстовые ноды и атрибуты.

### Тесты

Тесты находятся в `app/withdraw/WithdrawForm.test.tsx` и покрывают минимальные сценарии:

- **Happy path**: успешный submit, отображение созданной заявки и её статуса.
- **Ошибка API**: симулируется `409 Conflict`, отображается человекочитаемое сообщение в UI.
- **Защита от двойного submit**: при двух кликах по кнопке во время одного запроса фактически уходит только один HTTP-запрос.

